import React, {useEffect, useState} from 'react'

// 26:07 Electronics - Inventory Management System
const API = (path) => {
  const baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:4000'
  return baseUrl + path
}

export default function App(){
  const [tab, setTab] = useState('dashboard')
  const [products, setProducts] = useState([])
  const [customers, setCustomers] = useState([])
  const [cart, setCart] = useState([])
  const [selectedCustomer, setSelectedCustomer] = useState(null)
  const [invoices, setInvoices] = useState([])
  const [stats, setStats] = useState({})
  const [showAddProduct, setShowAddProduct] = useState(false)
  const [showAddCustomer, setShowAddCustomer] = useState(false)
  const [newProduct, setNewProduct] = useState({name:'', quantity:0, price:0, costPrice:0, hsnCode:'9999', minStock:10, sku:''})
  const [newCustomer, setNewCustomer] = useState({name:'', phone:'', address:'', gstin:''})
  const [loading, setLoading] = useState(true)
  const [discount, setDiscount] = useState(0)
  const [paymentMode, setPaymentMode] = useState('Cash')
  const [showBill, setShowBill] = useState(false)
  const [lastBill, setLastBill] = useState(null)
  const [searchQuery, setSearchQuery] = useState('') // Product search in POS
  const [taxRate, setTaxRate] = useState(18) // GST rate
  const [companyInfo, setCompanyInfo] = useState({
    name: '26:07 Electronics',
    address: 'Electronics Plaza, Tech Street, City - 560001',
    phone: '+91 9876543210',
    email: 'support@2607electronics.com',
    gstin: '29AABCU9603R1ZX',
    logo: '‚ö°'
  })
  
  // Authentication for modifications
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [isAdmin, setIsAdmin] = useState(false)
  const [currentUser, setCurrentUser] = useState(null)
  const [showAuthModal, setShowAuthModal] = useState(false)
  const [authUsername, setAuthUsername] = useState('')
  const [authPassword, setAuthPassword] = useState('')
  const [authError, setAuthError] = useState('')
  const [pendingAction, setPendingAction] = useState(null)
  const [showUserManagement, setShowUserManagement] = useState(false)
  const [users, setUsers] = useState([])
  const [showRegisterModal, setShowRegisterModal] = useState(false)
  const [registerUsername, setRegisterUsername] = useState('')
  const [registerPassword, setRegisterPassword] = useState('')
  const [registerEmail, setRegisterEmail] = useState('')
  const [registerError, setRegisterError] = useState('')
  const [showLoginPage, setShowLoginPage] = useState(true) // Toggle between login/register page
  
  // OTP Verification states
  const [otpStep, setOtpStep] = useState(1) // 1: Email, 2: OTP, 3: Registration
  const [otpCode, setOtpCode] = useState('')
  const [otpSent, setOtpSent] = useState(false)
  const [otpVerified, setOtpVerified] = useState(false)
  const [otpTimer, setOtpTimer] = useState(0)
  const [resendEnabled, setResendEnabled] = useState(true)
  const [otpLoading, setOtpLoading] = useState(false)
  const [auditLogs, setAuditLogs] = useState([]) // Audit trail logs
  const [showCustomerHistory, setShowCustomerHistory] = useState(false)
  const [selectedCustomerHistory, setSelectedCustomerHistory] = useState(null)
  const [customerPurchases, setCustomerPurchases] = useState([])
  
  // New advanced features
  const [showQuickActions, setShowQuickActions] = useState(false)
  const [notification, setNotification] = useState(null)
  const [showStockAlert, setShowStockAlert] = useState(false)
  const [showSalesChart, setShowSalesChart] = useState(false)
  const [productFilter, setProductFilter] = useState('all') // 'all', 'low-stock', 'out-of-stock', 'high-profit'
  const [sortBy, setSortBy] = useState('name') // 'name', 'stock', 'price', 'profit'
  const [showProductDetails, setShowProductDetails] = useState(false)
  const [selectedProduct, setSelectedProduct] = useState(null)
  const [recentActivity, setRecentActivity] = useState([])
  
  // Admin password from secure environment variable
  const ADMIN_PASSWORD = import.meta.env.VITE_ADMIN_PASSWORD || 'defaultpass123'

  // Check authentication on mount (permanent session until logout)
  useEffect(() => {
    const storedUser = localStorage.getItem('currentUser')
    const storedIsAdmin = localStorage.getItem('isAdmin')
    
    if (storedUser) {
      setIsAuthenticated(true)
      setCurrentUser(JSON.parse(storedUser))
      setIsAdmin(storedIsAdmin === 'true')
      
      // Fetch users if admin
      if (storedIsAdmin === 'true') {
        fetchUsers()
      }
    }
  }, [])

  async function fetchUsers() {
    try {
      const res = await fetch(API('/api/users'))
      if (res.ok) {
        const data = await res.json()
        setUsers(data)
      }
    } catch(e) {
      console.error('Error fetching users:', e)
    }
  }

  async function fetchAuditLogs() {
    try {
      const res = await fetch(API('/api/audit-logs?limit=100'))
      if (res.ok) {
        const data = await res.json()
        setAuditLogs(data)
      }
    } catch(e) {
      console.error('Error fetching audit logs:', e)
    }
  }

  useEffect(()=>{ 
    Promise.all([fetchProducts(), fetchCustomers(), fetchInvoices(), fetchStats()])
      .finally(() => setLoading(false))
  }, [])
  
  // Check if user account is still valid (not deleted by admin)
  async function checkUserValidity() {
    if (!isAuthenticated || isAdmin) return true // Admin always valid
    
    try {
      const res = await fetch(API(`/api/users/check/${currentUser.id}`))
      const data = await res.json()
      
      if (!res.ok || !data.exists) {
        // User account was deleted by admin
        alert('‚ö†Ô∏è Your account has been removed by the administrator. You will be logged out.')
        handleLogout()
        return false
      }
      
      if (!data.approved) {
        // User account was un-approved by admin
        alert('‚ö†Ô∏è Your account approval has been revoked by the administrator. You will be logged out.')
        handleLogout()
        return false
      }
      
      return true
    } catch(e) {
      console.error('User validity check error:', e)
      return true // Don't interrupt user on network errors
    }
  }
  
  // Check user validity periodically (every 30 seconds)
  useEffect(() => {
    if (isAuthenticated && !isAdmin) {
      const interval = setInterval(() => {
        checkUserValidity()
      }, 30000) // Check every 30 seconds
      
      return () => clearInterval(interval)
    }
  }, [isAuthenticated, isAdmin, currentUser])

  async function fetchProducts(){
    try {
      const res = await fetch(API('/api/products'))
      if (res.ok) setProducts(await res.json())
    } catch(e) { console.error('Error fetching products:', e) }
  }
  async function fetchCustomers(){
    try {
      const res = await fetch(API('/api/customers'))
      if (res.ok) setCustomers(await res.json())
    } catch(e) { console.error('Error fetching customers:', e) }
  }
  async function fetchInvoices(){
    try {
      const res = await fetch(API('/api/invoices'))
      if (res.ok) setInvoices(await res.json())
    } catch(e) { console.error('Error fetching invoices:', e) }
  }
  async function fetchStats(){
    try {
      const res = await fetch(API('/api/stats'))
      if (res.ok) setStats(await res.json())
    } catch(e) { console.error('Error fetching stats:', e) }
  }

  // Authentication checker - requires auth for any modification action
  async function requireAuth(action) {
    if (isAuthenticated) {
      // Check if user account is still valid
      const isValid = await checkUserValidity()
      if (isValid) {
        action() // Already authenticated and valid, execute immediately
      }
    } else {
      setPendingAction(() => action) // Store the action
      setShowAuthModal(true) // Show authentication modal
    }
  }

  // Handle authentication (permanent session until logout)
  async function handleAuth(e) {
    e.preventDefault()
    
    // Check if admin login
    if (authUsername === 'admin' && authPassword === ADMIN_PASSWORD) {
      // Admin login
      const adminUser = { username: 'admin', role: 'admin', approved: true }
      
      localStorage.setItem('currentUser', JSON.stringify(adminUser))
      localStorage.setItem('isAdmin', 'true')
      
      setIsAuthenticated(true)
      setIsAdmin(true)
      setCurrentUser(adminUser)
      setShowAuthModal(false)
      setAuthError('')
      setAuthUsername('')
      setAuthPassword('')
      
      alert(`‚úÖ Admin authenticated successfully!`)
      
      fetchUsers()
      
      if (pendingAction) {
        pendingAction()
        setPendingAction(null)
      }
    } else {
      // Regular user login
      try {
        const res = await fetch(API('/api/users/login'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username: authUsername, password: authPassword })
        })
        
        const data = await res.json()
        
        if (res.ok && data.user) {
          if (!data.user.approved) {
            setAuthError('‚è≥ Your account is pending admin approval.')
            setAuthUsername('')
            setAuthPassword('')
            return
          }
          
          // User login successful
          localStorage.setItem('currentUser', JSON.stringify(data.user))
          localStorage.setItem('isAdmin', 'false')
          
          setIsAuthenticated(true)
          setIsAdmin(false)
          setCurrentUser(data.user)
          setShowAuthModal(false)
          setAuthError('')
          setAuthUsername('')
          setAuthPassword('')
          
          alert(`‚úÖ Welcome ${data.user.username}! You're now logged in.`)
          
          if (pendingAction) {
            pendingAction()
            setPendingAction(null)
          }
        } else {
          setAuthError(data.error || 'Invalid username or password!')
          setAuthPassword('')
        }
      } catch(e) {
        console.error('Login error:', e)
        setAuthError('Login failed. Please try again.')
        setAuthPassword('')
      }
    }
  }
  
  // Logout function
  function handleLogout() {
    setIsAuthenticated(false)
    setIsAdmin(false)
    setCurrentUser(null)
    localStorage.removeItem('currentUser')
    localStorage.removeItem('isAdmin')
    alert('üîí You have been logged out.')
  }
  
  // User registration (Simple Direct)
  // Step 1: Send OTP
  async function handleSendOTP(e) {
    e.preventDefault()
    
    if (!registerEmail) {
      setRegisterError('Please enter your email address.')
      return
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(registerEmail)) {
      setRegisterError('Please enter a valid email address.')
      return
    }
    
    setOtpLoading(true) // Show loading state
    console.log('Sending OTP to:', registerEmail);
    
    try {
      const res = await fetch(API('/api/users/send-otp'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: registerEmail })
      })
      
      const data = await res.json()
      console.log('Response:', data);
      
      if (res.ok) {
        setOtpSent(true)
        setOtpStep(2)
        setRegisterError('')
        setOtpLoading(false)
        startOtpTimer(600) // 10 minutes
        
        // Show message based on whether email was sent
        if (data.emailSent) {
          showNotification('‚úÖ OTP sent to your email! Check inbox and spam folder.', 'success')
        } else {
          // Email failed, show OTP in console for testing
          console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
          console.log('‚ö†Ô∏è EMAIL FAILED - Using OTP from console');
          console.log('ÔøΩ YOUR OTP CODE:', data.otp);
          console.log('üìß For:', registerEmail);
          console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
          showNotification('‚ö†Ô∏è Email failed. OTP shown in console (F12)', 'error')
        }
      } else {
        setOtpLoading(false)
        setRegisterError(data.error || 'Failed to send OTP.')
      }
    } catch(e) {
      console.error('Send OTP error:', e)
      setOtpLoading(false)
      setRegisterError('Failed to send OTP. Please try again.')
    }
  }

  // Step 2: Verify OTP
  async function handleVerifyOTP(e) {
    e.preventDefault()
    
    if (!otpCode || otpCode.length !== 6) {
      setRegisterError('Please enter a valid 6-digit OTP.')
      return
    }
    
    setOtpLoading(true)
    
    try {
      const res = await fetch(API('/api/users/verify-otp'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          email: registerEmail, 
          otp: otpCode 
        })
      })
      
      const data = await res.json()
      
      if (res.ok) {
        setOtpVerified(true)
        setOtpStep(3)
        setRegisterError('')
        setOtpLoading(false)
        showNotification('‚úÖ Email verified successfully!', 'success')
      } else {
        setOtpLoading(false)
        setRegisterError(data.error || 'Invalid OTP.')
      }
    } catch(e) {
      console.error('Verify OTP error:', e)
      setOtpLoading(false)
      setRegisterError('Failed to verify OTP. Please try again.')
    }
  }

  // Step 3: Complete Registration
  async function handleRegister(e) {
    e.preventDefault()
    
    if (!otpVerified) {
      setRegisterError('Please verify your email first.')
      return
    }

    if (registerUsername.length < 3) {
      setRegisterError('Username must be at least 3 characters.')
      return
    }
    
    if (registerPassword.length < 6) {
      setRegisterError('Password must be at least 6 characters long.')
      return
    }
    
    try {
      const res = await fetch(API('/api/users/register'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          username: registerUsername, 
          password: registerPassword,
          email: registerEmail
        })
      })
      
      const data = await res.json()
      
      if (res.ok) {
        // Reset all states
        setShowRegisterModal(false)
        setRegisterUsername('')
        setRegisterPassword('')
        setRegisterEmail('')
        setRegisterError('')
        setOtpCode('')
        setOtpStep(1)
        setOtpSent(false)
        setOtpVerified(false)
        setOtpTimer(0)
        showNotification('‚úÖ Registration successful! Please wait for admin approval.', 'success')
        setShowLoginPage(true)
      } else {
        setRegisterError(data.error || 'Registration failed.')
      }
    } catch(e) {
      console.error('Registration error:', e)
      setRegisterError('Registration failed. Please try again.')
    }
  }

  // Resend OTP
  async function handleResendOTP() {
    if (!resendEnabled) return
    
    setResendEnabled(false)
    
    try {
      const res = await fetch(API('/api/users/send-otp'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: registerEmail })
      })
      
      const data = await res.json()
      
      if (res.ok) {
        setOtpCode('')
        setRegisterError('')
        startOtpTimer(600)
        showNotification('‚úÖ New OTP sent to your email!', 'success')
        setTimeout(() => setResendEnabled(true), 60000) // Enable after 1 minute
      } else {
        setRegisterError(data.error || 'Failed to resend OTP.')
        setResendEnabled(true)
      }
    } catch(e) {
      console.error('Resend OTP error:', e)
      setRegisterError('Failed to resend OTP.')
      setResendEnabled(true)
    }
  }

  // Timer countdown
  function startOtpTimer(seconds) {
    setOtpTimer(seconds)
    const interval = setInterval(() => {
      setOtpTimer(prev => {
        if (prev <= 1) {
          clearInterval(interval)
          return 0
        }
        return prev - 1
      })
    }, 1000)
  }

  // Format timer display
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60)
    const secs = seconds % 60
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }
  
  // Approve user (Admin only)
  async function approveUser(userId) {
    if (!isAdmin) return
    
    try {
      const res = await fetch(API(`/api/users/${userId}/approve`), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'}
      })
      
      if (res.ok) {
        alert('‚úÖ User approved successfully!')
        fetchUsers()
      } else {
        alert('Failed to approve user.')
      }
    } catch(e) {
      console.error('Approve error:', e)
      alert('Failed to approve user.')
    }
  }
  
  // Delete user (Admin only)
  async function deleteUser(userId) {
    if (!isAdmin) return
    
    if (!confirm('Are you sure you want to delete this user? They will be immediately logged out.')) return
    
    try {
      const res = await fetch(API(`/api/users/${userId}`), {
        method: 'DELETE'
      })
      
      const data = await res.json()
      
      if (res.ok) {
        alert('‚úÖ User deleted successfully! They have been logged out.')
        
        // If the deleted user is the current logged-in user (shouldn't happen, but safety check)
        const storedUser = localStorage.getItem('currentUser')
        if (storedUser) {
          const userData = JSON.parse(storedUser)
          if (data.deletedUserId && userData.id === data.deletedUserId) {
            // Force logout if somehow admin deleted themselves
            handleLogout()
          }
        }
        
        fetchUsers()
      } else {
        alert('Failed to delete user.')
      }
    } catch(e) {
      console.error('Delete error:', e)
      alert('Failed to delete user.')
    }
  }
  
  // Force logout user (Admin only) - removes user session
  function forceLogoutUser(username) {
    if (!isAdmin) return
    
    if (!confirm(`Force logout user "${username}"? They will need to login again.`)) return
    
    // In a real app, this would invalidate the session on the server
    // For now, we'll just show a confirmation that it would work
    alert(`‚úÖ User "${username}" has been force logged out. They will need to login again on their next action.`)
  }
  
  // Revoke user access (Admin only) - unapprove user
  async function revokeUserAccess(userId, username) {
    if (!isAdmin) return
    
    if (!confirm(`Revoke access for user "${username}"? They will be logged out immediately.`)) return
    
    try {
      const res = await fetch(API(`/api/users/${userId}/unapprove`), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'}
      })
      
      if (res.ok) {
        alert(`‚úÖ Access revoked for "${username}". They will be logged out on their next action.`)
        fetchUsers()
      } else {
        alert('Failed to revoke access.')
      }
    } catch(e) {
      console.error('Revoke access error:', e)
      alert('Failed to revoke access.')
    }
  }

  function cancelAuth() {
    setShowAuthModal(false)
    setAuthError('')
    setAuthPassword('')
    setPendingAction(null)
  }

  // Notification System
  function showNotification(message, type = 'success') {
    setNotification({ message, type })
    setTimeout(() => setNotification(null), 3000)
  }

  // Check for low stock on load
  useEffect(() => {
    if (products.length > 0) {
      const lowStockItems = products.filter(p => p.quantity > 0 && p.quantity <= p.minStock)
      const outOfStockItems = products.filter(p => p.quantity === 0)
      
      if (lowStockItems.length > 0 || outOfStockItems.length > 0) {
        setShowStockAlert(true)
      }
    }
  }, [products])

  // Track recent activity
  function addActivity(action, details) {
    const activity = {
      id: Date.now(),
      action,
      details,
      timestamp: new Date(),
      user: isAdmin ? 'Admin' : currentUser?.username
    }
    setRecentActivity(prev => [activity, ...prev.slice(0, 9)])
  }

  // Filter and sort products
  function getFilteredProducts() {
    let filtered = [...products]
    
    // Apply filter
    switch(productFilter) {
      case 'low-stock':
        filtered = filtered.filter(p => p.quantity > 0 && p.quantity <= p.minStock)
        break
      case 'out-of-stock':
        filtered = filtered.filter(p => p.quantity === 0)
        break
      case 'high-profit':
        filtered = filtered.filter(p => p.profitPercent >= 30)
        break
      default:
        break
    }
    
    // Apply sort
    switch(sortBy) {
      case 'stock':
        filtered.sort((a, b) => a.quantity - b.quantity)
        break
      case 'price':
        filtered.sort((a, b) => b.price - a.price)
        break
      case 'profit':
        filtered.sort((a, b) => b.profit - a.profit)
        break
      case 'name':
      default:
        filtered.sort((a, b) => a.name.localeCompare(b.name))
        break
    }
    
    return filtered
  }

  // Quick add to cart with animation
  function quickAddToCart(product, quantity = 1) {
    for (let i = 0; i < quantity; i++) {
      addToCart(product)
    }
    showNotification(`Added ${quantity}x ${product.name} to cart!`, 'success')
  }

  // Bulk stock update
  async function bulkUpdateStock(updates) {
    try {
      for (const update of updates) {
        await updateStock(update.id, update.quantity)
      }
      showNotification('Bulk stock update successful!', 'success')
      fetchProducts()
    } catch(e) {
      showNotification('Bulk update failed', 'error')
    }
  }

  // Download Reports Functions
  function downloadCSV(data, filename) {
    const csvContent = data.map(row => row.join(',')).join('\n')
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    link.href = URL.createObjectURL(blob)
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`
    link.click()
  }

  function downloadSalesReport() {
    const headers = ['Invoice #', 'Date', 'Customer', 'Items', 'Total', 'Payment Mode', 'Profit']
    const rows = invoices.map(inv => [
      inv.billNumber || inv.id,
      new Date(inv.date).toLocaleDateString(),
      inv.customerName || 'Walk-in',
      inv.items?.length || 0,
      `‚Çπ${inv.grandTotal || inv.total}`,
      inv.paymentMode || 'N/A',
      `‚Çπ${inv.totalProfit || 0}`
    ])
    downloadCSV([headers, ...rows], 'Sales_Report')
    alert('‚úÖ Sales Report Downloaded!')
  }

  function downloadInventoryReport() {
    const headers = ['Product ID', 'Name', 'Stock', 'Price', 'Cost Price', 'Profit/Unit', 'HSN Code', 'Status']
    const rows = products.map(prod => [
      prod.id,
      prod.name,
      prod.quantity,
      `‚Çπ${prod.price}`,
      `‚Çπ${prod.costPrice || 0}`,
      `‚Çπ${(prod.price - (prod.costPrice || 0)).toFixed(2)}`,
      prod.hsnCode || 'N/A',
      prod.quantity <= (prod.minStock || 10) ? 'Low Stock' : 'In Stock'
    ])
    downloadCSV([headers, ...rows], 'Inventory_Report')
    alert('‚úÖ Inventory Report Downloaded!')
  }

  function downloadCustomerReport() {
    const headers = ['Customer ID', 'Name', 'Phone', 'Address', 'GSTIN']
    const rows = customers.map(cust => [
      cust.id,
      cust.name,
      cust.phone,
      cust.address || 'N/A',
      cust.gstin || 'N/A'
    ])
    downloadCSV([headers, ...rows], 'Customer_Report')
    alert('‚úÖ Customer Report Downloaded!')
  }

  function downloadProfitReport() {
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.grandTotal || inv.total || 0), 0)
    const totalProfit = invoices.reduce((sum, inv) => sum + (inv.totalProfit || 0), 0)
    const profitMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(2) : 0
    
    const headers = ['Metric', 'Value']
    const rows = [
      ['Total Revenue', `‚Çπ${totalRevenue.toFixed(2)}`],
      ['Total Profit', `‚Çπ${totalProfit.toFixed(2)}`],
      ['Profit Margin', `${profitMargin}%`],
      ['Total Invoices', invoices.length],
      ['Average Profit/Sale', `‚Çπ${(totalProfit / (invoices.length || 1)).toFixed(2)}`],
      ['Total Products', products.length],
      ['Total Customers', customers.length],
      ['Low Stock Items', products.filter(p => p.quantity <= (p.minStock || 10)).length],
    ]
    downloadCSV([headers, ...rows], 'Profit_Analysis_Report')
    alert('‚úÖ Profit Analysis Report Downloaded!')
  }

  function addToCart(p){
    if (!p || !p.id) {
      console.error('Invalid product:', p);
      showNotification('Error: Invalid product', 'error');
      return;
    }
    console.log('Adding to cart:', p.name, 'ID:', p.id);
    setCart(c=>{
      const existing = c.find(x=>x.productId===p.id)
      if (existing) {
        console.log('Increasing quantity for:', p.name);
        return c.map(x=> x.productId===p.id ? {...x, quantity: x.quantity+1} : x)
      }
      console.log('Adding new item to cart:', p.name);
      return [...c, {productId: p.id, name: p.name, price: p.price, quantity:1}]
    })
  }

  function increaseCartQty(productId){
    setCart(c=> c.map(x=> x.productId===productId ? {...x, quantity: x.quantity+1} : x))
  }

  function decreaseCartQty(productId){
    setCart(c=> c.map(x=> x.productId===productId ? {...x, quantity: Math.max(1, x.quantity-1)} : x))
  }

  function removeFromCart(productId){
    setCart(c=> c.filter(x=> x.productId !== productId))
  }

  async function checkout(){
    try {
      const subtotal = cart.reduce((s,it)=> s + it.price*it.quantity, 0);
      const discountAmount = subtotal * discount / 100;
      const afterDiscount = subtotal - discountAmount;
      const taxAmount = afterDiscount * (taxRate / 100);
      const grandTotal = afterDiscount + taxAmount;
      
      const payload = { 
        customerId: selectedCustomer?.id || null, 
        total: grandTotal,
        subtotal: subtotal,
        discountAmount: discountAmount,
        discountValue: discount,
        taxRate: taxRate,
        taxAmount: taxAmount,
        items: cart,
        discountPercent: discount,
        customerState: 'Same',
        paymentMode: paymentMode,
        userId: currentUser?.id || null,
        username: isAdmin ? 'admin' : currentUser?.username
      }
      const res = await fetch(API('/api/checkout'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      const j = await res.json()
      if (j.billId) { 
        // Store bill data and show bill modal
        setLastBill(j);
        setShowBill(true);
        
        // Show success notification
        showNotification(`‚úì Sale completed! Bill #${j.billId}`, 'success');
        
        // Track activity
        addActivity('Sale Completed', `Bill #${j.billId} - ‚Çπ${grandTotal.toFixed(2)}`);
        
        // Clear cart and reset form
        setCart([]); 
        setSelectedCustomer(null);
        setDiscount(0);
        setPaymentMode('Cash');
        setSearchQuery('');
        
        // Refresh data
        fetchProducts(); 
        fetchInvoices(); 
        fetchStats() 
      } else if (j.error) {
        showNotification('Checkout failed: ' + j.error, 'error');
      }
    } catch(e) {
      console.error('Checkout error:', e)
      showNotification('Checkout failed. Please try again.', 'error');
    }
  }
  
  function printBill() {
    if (!lastBill) return;
    
    const printWindow = window.open('', '_blank');
    
    // Calculate bill details
    const subtotal = lastBill.items.reduce((s, it) => s + (it.price * it.quantity), 0);
    const discountAmount = (subtotal * discount / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * (taxRate / 100);
    const grandTotal = afterDiscount + taxAmount;
    
    const billHTML = `
      <html>
        <head>
          <title>Invoice #${lastBill.billId}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
              font-family: 'Arial', sans-serif; 
              padding: 20mm; 
              background: #fff;
              color: #000;
              font-size: 11pt;
            }
            .invoice-box { 
              max-width: 800px; 
              margin: auto; 
              border: 1px solid #000;
              padding: 20px;
            }
            .header { 
              text-align: center; 
              border-bottom: 3px double #000;
              padding-bottom: 15px;
              margin-bottom: 15px;
            }
            .logo { font-size: 48px; margin-bottom: 5px; }
            .company-name { font-size: 24px; font-weight: bold; margin: 5px 0; }
            .company-details { font-size: 10pt; line-height: 1.4; color: #333; }
            .invoice-title { 
              text-align: center;
              font-size: 18px;
              font-weight: bold;
              background: #000;
              color: #fff;
              padding: 8px;
              margin: 15px 0;
              letter-spacing: 2px;
            }
            .section { 
              display: flex; 
              justify-content: space-between; 
              margin: 15px 0;
              padding: 10px 0;
            }
            .info-block { flex: 1; }
            .info-block h3 { 
              font-size: 11pt; 
              margin-bottom: 8px; 
              border-bottom: 2px solid #000;
              padding-bottom: 3px;
            }
            .info-block p { 
              margin: 4px 0; 
              font-size: 10pt;
              line-height: 1.5;
            }
            .label { font-weight: bold; display: inline-block; min-width: 80px; }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 15px 0;
              border: 1px solid #000;
            }
            th { 
              background: #000; 
              color: #fff; 
              padding: 10px 8px; 
              text-align: left;
              font-size: 10pt;
              border: 1px solid #000;
            }
            td { 
              padding: 8px; 
              border: 1px solid #000;
              font-size: 10pt;
            }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .totals-section { 
              margin-top: 20px;
              padding-top: 15px;
              border-top: 2px solid #000;
            }
            .totals-table {
              margin-left: auto;
              width: 300px;
              border: none;
            }
            .totals-table td {
              border: none;
              padding: 5px 10px;
              border-bottom: 1px dotted #ccc;
            }
            .totals-table .grand-total {
              font-size: 14pt;
              font-weight: bold;
              border-top: 3px double #000;
              border-bottom: 3px double #000;
              background: #f0f0f0;
            }
            .amount-words {
              margin: 15px 0;
              padding: 10px;
              background: #f9f9f9;
              border: 1px dashed #000;
              font-style: italic;
              font-size: 10pt;
            }
            .footer {
              margin-top: 30px;
              padding-top: 15px;
              border-top: 2px dashed #000;
              text-align: center;
              font-size: 10pt;
            }
            .terms {
              margin: 20px 0;
              font-size: 9pt;
              line-height: 1.5;
              padding: 10px;
              background: #f9f9f9;
            }
            .signature-section {
              display: flex;
              justify-content: space-between;
              margin-top: 40px;
            }
            .signature-box {
              text-align: center;
              padding-top: 40px;
              border-top: 1px solid #000;
              width: 200px;
            }
            @media print {
              body { padding: 0; }
              .no-print { display: none !important; }
              .invoice-box { border: none; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-box">
            <!-- Header -->
            <div class="header">
              <div class="logo">${companyInfo.logo}</div>
              <div class="company-name">${companyInfo.name}</div>
              <div class="company-details">
                ${companyInfo.address}<br>
                Phone: ${companyInfo.phone} | Email: ${companyInfo.email}<br>
                GSTIN: ${companyInfo.gstin}
              </div>
            </div>
            
            <!-- Invoice Title -->
            <div class="invoice-title">TAX INVOICE</div>
            
            <!-- Invoice & Customer Info -->
            <div class="section">
              <div class="info-block">
                <h3>Bill To:</h3>
                ${selectedCustomer ? `
                  <p><span class="label">Name:</span> ${selectedCustomer.name}</p>
                  <p><span class="label">Phone:</span> ${selectedCustomer.phone || 'N/A'}</p>
                  <p><span class="label">Address:</span> ${selectedCustomer.address || 'N/A'}</p>
                  ${selectedCustomer.gstin ? `<p><span class="label">GSTIN:</span> ${selectedCustomer.gstin}</p>` : ''}
                ` : `
                  <p><span class="label">Customer:</span> Walk-in Customer</p>
                `}
              </div>
              <div class="info-block" style="text-align: right;">
                <h3>Invoice Details:</h3>
                <p><span class="label">Invoice #:</span> ${lastBill.billId}</p>
                <p><span class="label">Date:</span> ${new Date(lastBill.date).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})}</p>
                <p><span class="label">Time:</span> ${new Date(lastBill.date).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</p>
                <p><span class="label">Payment:</span> ${paymentMode}</p>
              </div>
            </div>
            
            <!-- Items Table -->
            <table>
              <thead>
                <tr>
                  <th class="text-center">S.No</th>
                  <th>Product Name</th>
                  <th>HSN Code</th>
                  <th class="text-center">Qty</th>
                  <th class="text-right">Rate</th>
                  <th class="text-right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${lastBill.items.map((item, idx) => {
                  const product = products.find(p => p._id === item.productId);
                  return `
                    <tr>
                      <td class="text-center">${idx + 1}</td>
                      <td>${item.name}</td>
                      <td>${product?.hsnCode || 'N/A'}</td>
                      <td class="text-center">${item.quantity}</td>
                      <td class="text-right">‚Çπ${item.price.toFixed(2)}</td>
                      <td class="text-right">‚Çπ${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            
            <!-- Totals Section -->
            <div class="totals-section">
              <table class="totals-table">
                <tr>
                  <td>Subtotal:</td>
                  <td class="text-right">‚Çπ${subtotal.toFixed(2)}</td>
                </tr>
                ${discount > 0 ? `
                  <tr>
                    <td>Discount (${discount}%):</td>
                    <td class="text-right">- ‚Çπ${discountAmount.toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td>After Discount:</td>
                    <td class="text-right">‚Çπ${afterDiscount.toFixed(2)}</td>
                  </tr>
                ` : ''}
                <tr>
                  <td>GST (${taxRate}%):</td>
                  <td class="text-right">‚Çπ${taxAmount.toFixed(2)}</td>
                </tr>
                <tr class="grand-total">
                  <td><strong>GRAND TOTAL:</strong></td>
                  <td class="text-right"><strong>‚Çπ${grandTotal.toFixed(2)}</strong></td>
                </tr>
              </table>
            </div>
            
            <!-- Amount in Words -->
            <div class="amount-words">
              <strong>Amount in Words:</strong> ${numberToWords(Math.round(grandTotal))} Rupees Only
            </div>
            
            <!-- Terms & Conditions -->
            <div class="terms">
              <strong>Terms & Conditions:</strong><br>
              1. Goods once sold cannot be returned or exchanged.<br>
              2. Payment is due at the time of purchase.<br>
              3. Subject to local jurisdiction only.<br>
              4. E. & O.E. (Errors and Omissions Excepted)
            </div>
            
            <!-- Signature Section -->
            <div class="signature-section">
              <div class="signature-box">Customer Signature</div>
              <div class="signature-box">Authorized Signatory</div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
              <strong>Thank you for your business!</strong><br>
              This is a computer-generated invoice.
            </div>
          </div>
          
          <!-- Print Button -->
          <div class="no-print" style="text-align: center; margin: 20px;">
            <button onclick="window.print()" style="padding: 12px 30px; font-size: 14px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
              üñ®Ô∏è Print Invoice
            </button>
            <button onclick="window.close()" style="padding: 12px 30px; font-size: 14px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
              ‚úñÔ∏è Close
            </button>
          </div>
        </body>
      </html>
    `;
    
    printWindow.document.write(billHTML);
    printWindow.document.close();
  }
  
  // Convert number to words (Indian system)
  function numberToWords(num) {
    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    
    if (num === 0) return 'Zero';
    
    function convertHundreds(n) {
      let str = '';
      if (n > 99) {
        str += ones[Math.floor(n / 100)] + ' Hundred ';
        n %= 100;
      }
      if (n > 19) {
        str += tens[Math.floor(n / 10)] + ' ';
        n %= 10;
      } else if (n >= 10) {
        str += teens[n - 10] + ' ';
        return str.trim();
      }
      str += ones[n] + ' ';
      return str.trim();
    }
    
    if (num >= 10000000) {
      return convertHundreds(Math.floor(num / 10000000)) + ' Crore ' + numberToWords(num % 10000000);
    }
    if (num >= 100000) {
      return convertHundreds(Math.floor(num / 100000)) + ' Lakh ' + numberToWords(num % 100000);
    }
    if (num >= 1000) {
      return convertHundreds(Math.floor(num / 1000)) + ' Thousand ' + numberToWords(num % 1000);
    }
    return convertHundreds(num);
  }

  async function addProduct(){
    try {
      const res = await fetch(API('/api/products'), { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({
          ...newProduct,
          userId: currentUser?.id || null,
          username: isAdmin ? 'admin' : currentUser?.username
        })
      })
      if (res.ok) { 
        showNotification(`‚úì Product "${newProduct.name}" added successfully!`, 'success');
        addActivity('Product Added', newProduct.name);
        setShowAddProduct(false); 
        setNewProduct({name:'', quantity:0, price:0, costPrice:0, hsnCode:'9999', minStock:10}); 
        fetchProducts(); 
        fetchStats();
      } else {
        const err = await res.json()
        showNotification('Failed to add product: ' + (err.error || 'Unknown error'), 'error');
      }
    } catch(e) {
      console.error('Add product error:', e)
      showNotification('Failed to add product. Please try again.', 'error');
    }
  }

  async function addCustomer(){
    try {
      const res = await fetch(API('/api/customers'), { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({
          ...newCustomer,
          userId: currentUser?.id || null,
          username: isAdmin ? 'admin' : currentUser?.username
        })
      })
      if (res.ok) { 
        showNotification(`‚úì Customer "${newCustomer.name}" added successfully!`, 'success');
        addActivity('Customer Added', newCustomer.name);
        setShowAddCustomer(false); 
        setNewCustomer({name:'', phone:'', address:'', state:'Same', gstin:''}); 
        fetchCustomers(); 
        fetchStats();
      } else {
        const err = await res.json()
        showNotification('Failed to add customer: ' + (err.error || 'Unknown error'), 'error');
      }
    } catch(e) {
      console.error('Add customer error:', e)
      showNotification('Failed to add customer. Please try again.', 'error');
    }
  }

  async function updateStock(productId, newQty){
    try {
      const res = await fetch(API(`/api/products/${productId}`), { 
        method:'PATCH', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({
          quantity: newQty,
          userId: currentUser?.id || null,
          username: isAdmin ? 'admin' : currentUser?.username
        })
      })
      if (res.ok) { 
        fetchProducts(); 
        fetchStats(); 
      } else {
        const err = await res.json()
        alert('Failed to update stock: ' + (err.error || 'Unknown error'))
      }
    } catch(e) {
      console.error('Update stock error:', e)
      alert('Failed to update stock. Please try again.')
    }
  }

  async function seedDatabase() {
    if (!isAdmin) {
      alert('Only admin can seed the database');
      return;
    }
    
    if (!confirm('This will add 50 sample products and 10 sample customers. Continue?')) {
      return;
    }
    
    try {
      const res = await fetch(API('/api/seed'), { method: 'POST' });
      const data = await res.json();
      
      if (res.ok) {
        showNotification(`Database seeded! Added ${data.productsAdded} products and ${data.customersAdded} customers.`, 'success');
        fetchProducts();
        fetchCustomers();
        fetchStats();
      } else {
        alert(data.error || 'Failed to seed database');
      }
    } catch (e) {
      console.error('Seed error:', e);
      alert('Failed to seed database');
    }
  }

  async function deleteProduct(id){
    if (!confirm('Delete this product?')) return
    try {
      const userId = currentUser?.id || null;
      const username = isAdmin ? 'admin' : currentUser?.username;
      const res = await fetch(API(`/api/products/${id}?userId=${userId}&username=${username}`), { method:'DELETE' })
      if (res.ok) { 
        fetchProducts(); 
        fetchStats(); 
      } else {
        const err = await res.json()
        alert('Failed to delete product: ' + (err.error || 'Unknown error'))
      }
    } catch(e) {
      console.error('Delete product error:', e)
      alert('Failed to delete product. Please try again.')
    }
  }

  if (loading) {
    return (
      <div className="app">
        <header><h1>üìä Inventory Management</h1></header>
        <main style={{display:'flex',justifyContent:'center',alignItems:'center',height:'80vh',fontSize:'24px'}}>
          <div>Loading... üîÑ</div>
        </main>
      </div>
    )
  }

  // Show Login/Register page if not authenticated
  if (!isAuthenticated) {
    return (
      <div className="app">
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          padding: '20px'
        }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            width: '100%',
            maxWidth: '450px',
            overflow: 'hidden'
          }}>
            {/* Header */}
            <div style={{
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              padding: '40px 30px',
              textAlign: 'center',
              color: 'white'
            }}>
              <h1 style={{margin: '0 0 10px 0', fontSize: '48px'}}>‚ö°</h1>
              <h2 style={{
                margin: '0 0 5px 0', 
                fontSize: '32px',
                color: '#667eea',
                fontWeight: 'bold',
                textShadow: '0 2px 4px rgba(102, 126, 234, 0.3)',
                letterSpacing: '1px'
              }}>26:07 Electronics</h2>
              <p style={{
                margin: 0, 
                color: '#764ba2', 
                fontSize: '14px',
                fontWeight: '500',
                letterSpacing: '0.5px'
              }}>Premium Electronics & Smart Solutions</p>
            </div>

            {/* Toggle Buttons */}
            <div style={{
              display: 'flex',
              borderBottom: '2px solid #f0f0f0'
            }}>
              <button
                onClick={() => setShowLoginPage(true)}
                style={{
                  flex: 1,
                  padding: '15px',
                  border: 'none',
                  background: showLoginPage ? 'white' : '#f9f9f9',
                  borderBottom: showLoginPage ? '3px solid #667eea' : 'none',
                  color: showLoginPage ? '#667eea' : '#999',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  fontSize: '16px',
                  transition: 'all 0.3s'
                }}
              >
                Login
              </button>
              <button
                onClick={() => setShowLoginPage(false)}
                style={{
                  flex: 1,
                  padding: '15px',
                  border: 'none',
                  background: !showLoginPage ? 'white' : '#f9f9f9',
                  borderBottom: !showLoginPage ? '3px solid #667eea' : 'none',
                  color: !showLoginPage ? '#667eea' : '#999',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  fontSize: '16px',
                  transition: 'all 0.3s'
                }}
              >
                Register
              </button>
            </div>

            {/* Login Form */}
            {showLoginPage ? (
              <div style={{padding: '40px 30px'}}>
                <h3 style={{marginTop: 0, marginBottom: '25px', color: '#333', fontSize: '20px'}}>Welcome Back!</h3>
                <form onSubmit={handleAuth}>
                  <div style={{marginBottom: '20px'}}>
                    <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Username</label>
                    <input
                      type="text"
                      value={authUsername}
                      onChange={(e) => setAuthUsername(e.target.value)}
                      placeholder="Enter your username"
                      required
                      autoFocus
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        transition: 'border 0.3s',
                        boxSizing: 'border-box'
                      }}
                      onFocus={(e) => e.target.style.borderColor = '#667eea'}
                      onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                    />
                  </div>
                  <div style={{marginBottom: '25px'}}>
                    <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Password</label>
                    <input
                      type="password"
                      value={authPassword}
                      onChange={(e) => setAuthPassword(e.target.value)}
                      placeholder="Enter your password"
                      required
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '2px solid #e0e0e0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        transition: 'border 0.3s',
                        boxSizing: 'border-box'
                      }}
                      onFocus={(e) => e.target.style.borderColor = '#667eea'}
                      onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                    />
                  </div>
                  {authError && (
                    <div style={{
                      padding: '12px',
                      background: '#fee',
                      border: '1px solid #fcc',
                      borderRadius: '8px',
                      color: '#c33',
                      marginBottom: '20px',
                      fontSize: '14px'
                    }}>
                      {authError}
                    </div>
                  )}
                  <button
                    type="submit"
                    style={{
                      width: '100%',
                      padding: '14px',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      border: 'none',
                      borderRadius: '8px',
                      color: 'white',
                      fontSize: '16px',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                      transition: 'transform 0.2s'
                    }}
                    onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                    onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                  >
                    Login
                  </button>
                </form>
                <p style={{textAlign: 'center', marginTop: '20px', color: '#999', fontSize: '13px'}}>
                  üí° Admin credentials required for owner access
                </p>
              </div>
            ) : (
              /* Register Form with OTP Verification */
              <div style={{padding: '40px 30px'}}>
                {/* Progress Indicator */}
                <div style={{display: 'flex', justifyContent: 'center', marginBottom: '30px', gap: '10px'}}>
                  <div style={{
                    width: '30px', height: '30px', borderRadius: '50%',
                    background: otpStep >= 1 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0',
                    color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center',
                    fontWeight: 'bold', fontSize: '14px'
                  }}>1</div>
                  <div style={{width: '40px', height: '2px', background: otpStep >= 2 ? '#667eea' : '#e0e0e0', alignSelf: 'center'}}></div>
                  <div style={{
                    width: '30px', height: '30px', borderRadius: '50%',
                    background: otpStep >= 2 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0',
                    color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center',
                    fontWeight: 'bold', fontSize: '14px'
                  }}>2</div>
                  <div style={{width: '40px', height: '2px', background: otpStep >= 3 ? '#667eea' : '#e0e0e0', alignSelf: 'center'}}></div>
                  <div style={{
                    width: '30px', height: '30px', borderRadius: '50%',
                    background: otpStep >= 3 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0',
                    color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center',
                    fontWeight: 'bold', fontSize: '14px'
                  }}>3</div>
                </div>

                <h3 style={{marginTop: 0, marginBottom: '10px', color: '#333', fontSize: '20px', textAlign: 'center'}}>
                  {otpStep === 1 && 'Enter Your Email'}
                  {otpStep === 2 && 'Verify OTP'}
                  {otpStep === 3 && 'Complete Registration'}
                </h3>
                <p style={{textAlign: 'center', color: '#666', fontSize: '13px', marginBottom: '25px'}}>
                  {otpStep === 1 && "We'll send you a verification code"}
                  {otpStep === 2 && `Code sent to ${registerEmail}`}
                  {otpStep === 3 && 'Create your account credentials'}
                </p>

                {/* Step 1: Email Input */}
                {otpStep === 1 && (
                  <form onSubmit={handleSendOTP}>
                    <div style={{marginBottom: '20px'}}>
                      <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Email Address</label>
                      <input
                        type="email"
                        value={registerEmail}
                        onChange={(e) => setRegisterEmail(e.target.value)}
                        placeholder="your@email.com"
                        required
                        autoFocus
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #e0e0e0',
                          borderRadius: '8px',
                          fontSize: '14px',
                          transition: 'border 0.3s',
                          boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#667eea'}
                        onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                      />
                    </div>
                    {registerError && (
                      <div style={{
                        padding: '12px',
                        background: '#fee',
                        border: '1px solid #fcc',
                        borderRadius: '8px',
                        color: '#c33',
                        marginBottom: '20px',
                        fontSize: '14px'
                      }}>
                        {registerError}
                      </div>
                    )}
                    <button
                      type="submit"
                      disabled={otpLoading}
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: otpLoading ? '#ccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        border: 'none',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '16px',
                        fontWeight: 'bold',
                        cursor: otpLoading ? 'not-allowed' : 'pointer',
                        transition: 'transform 0.2s',
                        opacity: otpLoading ? 0.7 : 1
                      }}
                      onMouseOver={(e) => !otpLoading && (e.target.style.transform = 'translateY(-2px)')}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      {otpLoading ? '‚è≥ Sending...' : 'üìß Send OTP'}
                    </button>
                  </form>
                )}

                {/* Step 2: OTP Verification */}
                {otpStep === 2 && (
                  <form onSubmit={handleVerifyOTP}>
                    <div style={{marginBottom: '20px'}}>
                      <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Enter 6-Digit OTP</label>
                      <input
                        type="text"
                        value={otpCode}
                        onChange={(e) => {
                          const val = e.target.value.replace(/\D/g, '').slice(0, 6)
                          setOtpCode(val)
                        }}
                        placeholder="000000"
                        required
                        autoFocus
                        maxLength="6"
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #e0e0e0',
                          borderRadius: '8px',
                          fontSize: '24px',
                          letterSpacing: '8px',
                          textAlign: 'center',
                          fontWeight: 'bold',
                          transition: 'border 0.3s',
                          boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#667eea'}
                        onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                      />
                    </div>
                    
                    {otpTimer > 0 && (
                      <div style={{textAlign: 'center', marginBottom: '15px', color: '#667eea', fontSize: '14px', fontWeight: '500'}}>
                        ‚è± OTP expires in {formatTime(otpTimer)}
                      </div>
                    )}

                    {registerError && (
                      <div style={{
                        padding: '12px',
                        background: '#fee',
                        border: '1px solid #fcc',
                        borderRadius: '8px',
                        color: '#c33',
                        marginBottom: '20px',
                        fontSize: '14px'
                      }}>
                        {registerError}
                      </div>
                    )}

                    <button
                      type="submit"
                      disabled={otpLoading}
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: otpLoading ? '#ccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        border: 'none',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '16px',
                        fontWeight: 'bold',
                        cursor: otpLoading ? 'not-allowed' : 'pointer',
                        transition: 'transform 0.2s',
                        marginBottom: '10px',
                        opacity: otpLoading ? 0.7 : 1
                      }}
                      onMouseOver={(e) => !otpLoading && (e.target.style.transform = 'translateY(-2px)')}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      {otpLoading ? '‚è≥ Verifying...' : '‚úÖ Verify OTP'}
                    </button>

                    <button
                      type="button"
                      onClick={handleResendOTP}
                      disabled={!resendEnabled}
                      style={{
                        width: '100%',
                        padding: '12px',
                        background: 'transparent',
                        border: '2px solid #667eea',
                        borderRadius: '8px',
                        color: resendEnabled ? '#667eea' : '#ccc',
                        fontSize: '14px',
                        fontWeight: 'bold',
                        cursor: resendEnabled ? 'pointer' : 'not-allowed',
                        transition: 'all 0.2s'
                      }}
                    >
                      {resendEnabled ? 'üîÑ Resend OTP' : '‚è≥ Wait 1 minute'}
                    </button>
                  </form>
                )}

                {/* Step 3: Complete Registration */}
                {otpStep === 3 && (
                  <form onSubmit={handleRegister}>
                    <div style={{marginBottom: '20px'}}>
                      <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Username</label>
                      <input
                        type="text"
                        value={registerUsername}
                        onChange={(e) => setRegisterUsername(e.target.value)}
                        placeholder="Choose a username"
                        required
                        autoFocus
                        minLength="3"
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #e0e0e0',
                          borderRadius: '8px',
                          fontSize: '14px',
                          transition: 'border 0.3s',
                          boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#667eea'}
                        onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                      />
                    </div>
                    <div style={{marginBottom: '25px'}}>
                      <label style={{display: 'block', marginBottom: '8px', color: '#555', fontWeight: '500'}}>Password</label>
                      <input
                        type="password"
                        value={registerPassword}
                        onChange={(e) => setRegisterPassword(e.target.value)}
                        placeholder="Minimum 6 characters"
                        required
                        minLength="6"
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #e0e0e0',
                          borderRadius: '8px',
                          fontSize: '14px',
                          transition: 'border 0.3s',
                          boxSizing: 'border-box'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#667eea'}
                        onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                      />
                    </div>
                    <div style={{marginBottom: '20px', padding: '12px', background: '#f0f9ff', border: '1px solid #bfdbfe', borderRadius: '8px'}}>
                      <div style={{fontSize: '13px', color: '#1e40af', marginBottom: '5px'}}>
                        ‚úÖ Email: <strong>{registerEmail}</strong>
                      </div>
                      <div style={{fontSize: '12px', color: '#64748b'}}>
                        Email verified successfully
                      </div>
                    </div>
                    {registerError && (
                      <div style={{
                        padding: '12px',
                        background: '#fee',
                        border: '1px solid #fcc',
                        borderRadius: '8px',
                        color: '#c33',
                        marginBottom: '20px',
                        fontSize: '14px'
                      }}>
                        {registerError}
                      </div>
                    )}
                    <button
                      type="submit"
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        border: 'none',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '16px',
                        fontWeight: 'bold',
                        cursor: 'pointer',
                        transition: 'transform 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      Complete Registration
                    </button>
                  </form>
                )}

                <p style={{textAlign: 'center', marginTop: '20px', color: '#999', fontSize: '13px'}}>
                  ‚úÖ Admin will review and approve your access
                </p>
              </div>
            )}
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="app">
      {/* Notification Toast */}
      {notification && (
        <div className={`notification ${notification.type} slide-in`}>
          <span className="notification-icon">
            {notification.type === 'success' && '‚úì'}
            {notification.type === 'error' && '‚úï'}
            {notification.type === 'warning' && '‚ö†'}
            {notification.type === 'info' && '‚Ñπ'}
          </span>
          <span className="notification-message">{notification.message}</span>
          <button className="notification-close" onClick={() => setNotification(null)}>√ó</button>
        </div>
      )}

      {/* Quick Actions Floating Button */}
      <div className="quick-actions-wrapper">
        <button 
          className="quick-actions-btn bounce"
          onClick={() => setShowQuickActions(!showQuickActions)}
          title="Quick Actions"
        >
          ‚ö°
        </button>
        {showQuickActions && (
          <div className="quick-actions-menu fade-in">
            <button onClick={() => { setTab('pos'); setShowQuickActions(false); }}>
              üõí New Sale
            </button>
            <button onClick={() => { setTab('products'); setShowQuickActions(false); }}>
              ‚ûï Add Product
            </button>
            <button onClick={() => { setShowStockAlert(true); setShowQuickActions(false); }}>
              üìä Stock Alert
            </button>
            <button onClick={() => { setTab('reports'); setShowQuickActions(false); }}>
              üìà Reports
            </button>
            <button onClick={() => { 
              const lowStock = products.filter(p => p.quantity <= p.minStock);
              if (lowStock.length > 0) {
                setProductFilter('low-stock');
                setTab('products');
              } else {
                showNotification('No low stock items!', 'info');
              }
              setShowQuickActions(false);
            }}>
              üîî Low Stock
            </button>
          </div>
        )}
      </div>

      {/* Stock Alert Modal */}
      {showStockAlert && (
        <div className="modal-overlay" onClick={() => setShowStockAlert(false)}>
          <div className="modal slide-in" onClick={e => e.stopPropagation()}>
            <h2>üìä Stock Alerts</h2>
            <div className="stock-alerts">
              <h3 style={{color: '#e74c3c'}}>‚ö†Ô∏è Out of Stock ({products.filter(p => p.quantity === 0).length})</h3>
              <div className="alert-list">
                {products.filter(p => p.quantity === 0).map(p => (
                  <div key={p._id} className="alert-item out-of-stock">
                    <span className="alert-product">{p.name}</span>
                    <span className="alert-sku">{p.sku}</span>
                    <span className="alert-status">Out of Stock</span>
                  </div>
                ))}
              </div>
              
              <h3 style={{color: '#f39c12', marginTop: '20px'}}>‚ö†Ô∏è Low Stock ({products.filter(p => p.quantity > 0 && p.quantity <= p.minStock).length})</h3>
              <div className="alert-list">
                {products.filter(p => p.quantity > 0 && p.quantity <= p.minStock).map(p => (
                  <div key={p._id} className="alert-item low-stock">
                    <span className="alert-product">{p.name}</span>
                    <span className="alert-sku">{p.sku}</span>
                    <span className="alert-quantity">{p.quantity} / {p.minStock}</span>
                  </div>
                ))}
              </div>
            </div>
            <button onClick={() => setShowStockAlert(false)} className="btn-secondary">Close</button>
          </div>
        </div>
      )}

      {/* Product Details Modal */}
      {showProductDetails && selectedProduct && (
        <div className="modal-overlay" onClick={() => setShowProductDetails(false)}>
          <div className="modal product-details-modal slide-in" onClick={e => e.stopPropagation()}>
            <h2>üì¶ {selectedProduct.name}</h2>
            <div className="product-details-grid">
              <div className="detail-row">
                <span className="detail-label">SKU/Barcode:</span>
                <span className="detail-value">{selectedProduct.sku}</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Cost Price:</span>
                <span className="detail-value">‚Çπ{selectedProduct.cost}</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Selling Price:</span>
                <span className="detail-value">‚Çπ{selectedProduct.price}</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Profit:</span>
                <span className="detail-value profit">‚Çπ{selectedProduct.profit} ({selectedProduct.profitPercent}%)</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Current Stock:</span>
                <span className={`detail-value ${selectedProduct.quantity <= selectedProduct.minStock ? 'low-stock-text' : ''}`}>
                  {selectedProduct.quantity} units
                </span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Minimum Stock:</span>
                <span className="detail-value">{selectedProduct.minStock} units</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">GST Rate:</span>
                <span className="detail-value">{selectedProduct.gstRate}%</span>
              </div>
              <div className="detail-row">
                <span className="detail-label">Status:</span>
                <span className={`detail-value ${selectedProduct.quantity === 0 ? 'out-of-stock-text' : selectedProduct.quantity <= selectedProduct.minStock ? 'low-stock-text' : 'in-stock-text'}`}>
                  {selectedProduct.quantity === 0 ? 'üî¥ Out of Stock' : selectedProduct.quantity <= selectedProduct.minStock ? 'üü° Low Stock' : 'üü¢ In Stock'}
                </span>
              </div>
            </div>
            <div className="modal-actions">
              <button onClick={() => {
                quickAddToCart(selectedProduct, 1);
                setShowProductDetails(false);
              }} className="btn-primary" disabled={selectedProduct.quantity === 0}>
                üõí Add to Cart
              </button>
              <button onClick={() => setShowProductDetails(false)} className="btn-secondary">Close</button>
            </div>
          </div>
        </div>
      )}

      <header>
        <h1>
          <span style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            fontWeight: 'bold',
            fontSize: '32px'
          }}>‚ö° 26:07</span>
          <span style={{marginLeft: '8px'}}>Electronics</span>
        </h1>
        <nav>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('dashboard')}} className={tab==='dashboard'?'active':''}>Dashboard</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('pos')}} className={tab==='pos'?'active':''}>Transactions</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('products')}} className={tab==='products'?'active':''}>Products</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('inventory')}} className={tab==='inventory'?'active':''}>üì¶ Inventory</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('customers')}} className={tab==='customers'?'active':''}>Customers</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('invoices')}} className={tab==='invoices'?'active':''}>Invoices</button>
          <button onClick={async ()=>{if(await checkUserValidity())setTab('reports')}} className={tab==='reports'?'active':''}>Reports</button>
          {isAdmin && <button onClick={()=>{setTab('users');setShowUserManagement(true);fetchUsers()}} className={tab==='users'?'active':''}>üë• Users</button>}
          {isAdmin && <button onClick={()=>{setTab('audit');fetchAuditLogs()}} className={tab==='audit'?'active':''}>üìã Audit Logs</button>}
        </nav>
        <div style={{display:'inline-block', marginLeft:'20px', verticalAlign:'middle'}}>
          <span className="auth-badge authenticated">‚úì {isAdmin ? 'Admin' : currentUser?.username}</span>
          <button onClick={handleLogout} className="logout-btn" style={{marginLeft:'10px'}}>Logout</button>
        </div>
      </header>
      <main>
        {tab==='dashboard' && (
          <div className="dashboard">
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px'}}>
              <h2>Dashboard Overview</h2>
              {isAdmin && products.length === 0 && (
                <button onClick={seedDatabase} className="btn-primary" style={{background:'#10b981'}}>
                  üå± Seed Sample Data (50 Products + 10 Customers)
                </button>
              )}
            </div>
            <div className="stats-grid">
              <div className="stat-card scale-in" style={{animationDelay: '0s'}}>
                <div className="stat-icon"></div>
                <div className="stat-info">
                  <h3>‚Çπ{stats.totalRevenue || 0}</h3>
                  <p>Total Revenue</p>
                </div>
              </div>
              <div className="stat-card scale-in" style={{animationDelay: '0.1s'}}>
                <div className="stat-icon">üßæ</div>
                <div className="stat-info">
                  <h3>{stats.totalInvoices || 0}</h3>
                  <p>Total Invoices</p>
                </div>
              </div>
              <div className="stat-card scale-in" style={{animationDelay: '0.2s', cursor: stats.lowStockCount > 0 ? 'pointer' : 'default'}} onClick={() => {
                if (stats.lowStockCount > 0) {
                  setShowStockAlert(true);
                }
              }}>
                <div className="stat-icon">üìâ</div>
                <div className="stat-info">
                  <h3>{stats.lowStockCount || 0}</h3>
                  <p>Low Stock Items</p>
                </div>
              </div>
              <div className="stat-card scale-in" style={{animationDelay: '0.3s'}}>
                <div className="stat-icon">üìà</div>
                <div className="stat-info">
                  <h3>‚Çπ{stats.todaySales || 0}</h3>
                  <p>Today's Sales</p>
                </div>
              </div>

              <div className="stat-card scale-in" style={{animationDelay: '0.4s'}}>
                <div className="stat-icon">üí∞</div>
                <div className="stat-info">
                  <h3>‚Çπ{stats.todayProfit || 0}</h3>
                  <p>Today's Profit</p>
                </div>
              </div>
            </div>

            <div className="recent-section">
              <h3>Low Stock Alert</h3>
              <table>
                <thead><tr><th>Product</th><th>Current Stock</th><th>Status</th></tr></thead>
                <tbody>
                  {products.filter(p=>p.quantity<20).slice(0,5).map(p=>(
                    <tr key={p.id}>
                      <td>{p.name}</td>
                      <td>{p.quantity}</td>
                      <td><span className="badge danger">Low Stock</span></td>
                    </tr>
                  ))}
                  {products.filter(p=>p.quantity<20).length===0 && <tr><td colSpan="3">All products well stocked!</td></tr>}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {tab==='pos' && (
          <div className="pos">
            <div className="left">
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                <h2 style={{margin: 0}}>Products</h2>
                <input 
                  type="text" 
                  placeholder="üîç Search products..." 
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  style={{
                    padding: '8px 12px',
                    borderRadius: '8px',
                    border: '2px solid #e2e8f0',
                    fontSize: '13px',
                    width: '200px',
                    outline: 'none',
                    transition: 'all 0.2s'
                  }}
                  onFocus={(e) => e.target.style.borderColor = '#667eea'}
                  onBlur={(e) => e.target.style.borderColor = '#e2e8f0'}
                />
              </div>
              <ul className="products">
                {products
                  .filter(p => searchQuery === '' || 
                    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (p.sku && p.sku.toLowerCase().includes(searchQuery.toLowerCase()))
                  )
                  .map((p, idx)=> (
                    <li key={p.id} className="fade-in" style={{position: 'relative', animationDelay: `${idx * 0.03}s`}}>
                      {p.quantity === 0 && (
                        <div style={{
                          position: 'absolute',
                          top: '8px',
                          right: '8px',
                          background: '#feb2b2',
                          color: '#742a2a',
                          fontSize: '10px',
                          padding: '3px 6px',
                          borderRadius: '4px',
                          fontWeight: 'bold'
                        }}>
                          OUT
                        </div>
                      )}
                      {p.quantity > 0 && p.quantity < p.minStock && (
                        <div style={{
                          position: 'absolute',
                          top: '8px',
                          right: '8px',
                          background: '#feebc8',
                          color: '#7c2d12',
                          fontSize: '10px',
                          padding: '3px 6px',
                          borderRadius: '4px',
                          fontWeight: 'bold'
                        }}>
                          LOW
                        </div>
                      )}
                      <div><strong>{p.name}</strong></div>
                      {p.sku && <div style={{fontSize: '11px', color: '#666'}}>SKU: {p.sku}</div>}
                      <div>Qty: {p.quantity} ‚Ä¢ ‚Çπ{p.price}</div>
                      <button 
                        onClick={()=>{
                          addToCart(p);
                          showNotification(`Added ${p.name} to cart`, 'info');
                        }}
                        disabled={p.quantity === 0}
                        style={{opacity: p.quantity === 0 ? 0.5 : 1, cursor: p.quantity === 0 ? 'not-allowed' : 'pointer'}}
                      >
                        {p.quantity === 0 ? 'üö´ Out of Stock' : '‚ûï Add'}
                      </button>
                    </li>
                  ))
                }
              </ul>
            </div>
            <div className="right">
              <h2>Cart</h2>
              
              {/* Customer Selection */}
              <div className="form-group">
                <label>Customer:</label>
                <select value={selectedCustomer?.id || ''} onChange={e=> {
                  const cust = customers.find(c=>c.id==e.target.value);
                  setSelectedCustomer(cust);
                }}>
                  <option value="">Walk-in Customer</option>
                  {customers.map(c=> <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>

              {/* Cart Items */}
              <ul className="cart">
                {cart.map(it=> (
                  <li key={it.productId} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px', marginBottom:'5px', background:'#f9f9f9', borderRadius:'5px'}}>
                    <div style={{flex:1}}>
                      <strong>{it.name}</strong>
                      <div style={{fontSize:'12px', color:'#666'}}>‚Çπ{it.price} each</div>
                    </div>
                    <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                      <button 
                        onClick={()=>decreaseCartQty(it.productId)} 
                        style={{width:'32px', height:'32px', border:'2px solid #e53e3e', background:'white', color:'#e53e3e', cursor:'pointer', borderRadius:'6px', fontSize:'20px', fontWeight:'bold', display:'flex', alignItems:'center', justifyContent:'center', transition:'all 0.2s'}}
                        onMouseOver={(e)=>{e.target.style.background='#e53e3e'; e.target.style.color='white'}}
                        onMouseOut={(e)=>{e.target.style.background='white'; e.target.style.color='#e53e3e'}}
                        title="Decrease quantity"
                      >
                        ‚ûñ
                      </button>
                      <span style={{minWidth:'40px', textAlign:'center', fontWeight:'bold', fontSize:'16px'}}>{it.quantity}</span>
                      <button 
                        onClick={()=>increaseCartQty(it.productId)} 
                        style={{width:'32px', height:'32px', border:'2px solid #48bb78', background:'white', color:'#48bb78', cursor:'pointer', borderRadius:'6px', fontSize:'20px', fontWeight:'bold', display:'flex', alignItems:'center', justifyContent:'center', transition:'all 0.2s'}}
                        onMouseOver={(e)=>{e.target.style.background='#48bb78'; e.target.style.color='white'}}
                        onMouseOut={(e)=>{e.target.style.background='white'; e.target.style.color='#48bb78'}}
                        title="Increase quantity"
                      >
                        ‚ûï
                      </button>
                      <button 
                        onClick={()=>removeFromCart(it.productId)} 
                        style={{width:'32px', height:'32px', border:'none', background:'#f56565', color:'white', cursor:'pointer', borderRadius:'6px', marginLeft:'5px', fontSize:'18px', fontWeight:'bold', display:'flex', alignItems:'center', justifyContent:'center', transition:'all 0.2s'}}
                        onMouseOver={(e)=>e.target.style.background='#c53030'}
                        onMouseOut={(e)=>e.target.style.background='#f56565'}
                        title="Remove item"
                      >
                        üóëÔ∏è
                      </button>
                      <span style={{minWidth:'70px', textAlign:'right', fontWeight:'bold'}}>‚Çπ{(it.price*it.quantity).toFixed(2)}</span>
                    </div>
                  </li>
                ))}
              </ul>

              {/* Discount Section */}
              <div className="form-group">
                <label>Discount: {discount}%</label>
                <input type="range" min="0" max="50" value={discount} 
                       onChange={(e)=>setDiscount(parseFloat(e.target.value))}
                       style={{width:'100%'}} />
              </div>

              {/* GST Rate */}
              <div className="form-group">
                <label>GST Rate:</label>
                <select value={taxRate} onChange={(e)=>setTaxRate(parseFloat(e.target.value))}>
                  <option value="0">0% (Exempt)</option>
                  <option value="5">5% GST</option>
                  <option value="12">12% GST</option>
                  <option value="18">18% GST</option>
                  <option value="28">28% GST</option>
                </select>
              </div>

              {/* Payment Mode */}
              <div className="form-group">
                <label>Payment Mode:</label>
                <select value={paymentMode} onChange={(e)=>setPaymentMode(e.target.value)}>
                  <option value="Cash">üíµ Cash</option>
                  <option value="Card">üí≥ Card</option>
                  <option value="UPI">üì± UPI</option>
                  <option value="Net Banking">üè¶ Net Banking</option>
                  <option value="Cheque">üìù Cheque</option>
                </select>
              </div>

              {/* Bill Breakdown */}
              {cart.length > 0 && (() => {
                const subtotal = cart.reduce((s,it)=> s + it.price*it.quantity, 0);
                const discountAmount = subtotal * discount / 100;
                const afterDiscount = subtotal - discountAmount;
                const taxAmount = afterDiscount * (taxRate / 100);
                const grandTotal = afterDiscount + taxAmount;
                
                return (
                  <div className="bill-breakdown">
                    <div className="breakdown-row"><span>Subtotal:</span><span>‚Çπ{subtotal.toFixed(2)}</span></div>
                    {discount > 0 && (
                      <>
                        <div className="breakdown-row"><span>Discount ({discount}%):</span><span style={{color: '#48bb78'}}>-‚Çπ{discountAmount.toFixed(2)}</span></div>
                        <div className="breakdown-row"><span>After Discount:</span><span>‚Çπ{afterDiscount.toFixed(2)}</span></div>
                      </>
                    )}
                    {taxRate > 0 && <div className="breakdown-row"><span>GST ({taxRate}%):</span><span>‚Çπ{taxAmount.toFixed(2)}</span></div>}
                  </div>
                );
              })()}
              
              <div className="total">
                Grand Total: ‚Çπ{cart.length > 0 ? (() => {
                  const subtotal = cart.reduce((s,it)=> s + it.price*it.quantity, 0);
                  const discountAmount = (subtotal * discount / 100);
                  const afterDiscount = subtotal - discountAmount;
              const taxAmount = afterDiscount * (taxRate / 100);
              return (afterDiscount + taxAmount).toFixed(2);
            })() : '0.00'}
          </div>
          
          <button onClick={checkout} disabled={cart.length===0} className="btn-complete-sale">
            üí≥ Complete Sale
          </button>
        </div>
      </div>
    )}        {tab==='products' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2>Product Inventory</h2>
              <button onClick={()=>requireAuth(()=>setShowAddProduct(true))} className="btn-primary">+ Add Product</button>
            </div>
            
            {/* Filter and Sort Controls */}
            <div className="product-controls fade-in">
              <div className="filter-group">
                <label>üîç Filter:</label>
                <select value={productFilter} onChange={e => setProductFilter(e.target.value)} className="control-select">
                  <option value="all">All Products ({products.length})</option>
                  <option value="low-stock">Low Stock ({products.filter(p => p.quantity > 0 && p.quantity <= p.minStock).length})</option>
                  <option value="out-of-stock">Out of Stock ({products.filter(p => p.quantity === 0).length})</option>
                  <option value="high-profit">High Profit (‚â•30%) ({products.filter(p => p.profitPercent >= 30).length})</option>
                </select>
              </div>
              <div className="filter-group">
                <label>üìä Sort By:</label>
                <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="control-select">
                  <option value="name">Name (A-Z)</option>
                  <option value="stock">Stock (Low to High)</option>
                  <option value="price">Price (High to Low)</option>
                  <option value="profit">Profit (High to Low)</option>
                </select>
              </div>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Name</th>
                  <th>Stock</th>
                  <th>Cost Price</th>
                  <th>Selling Price</th>
                  <th>Profit</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {getFilteredProducts().map(prod => (
                  <tr key={prod.id} className="fade-in table-row-hover">
                    <td style={{fontFamily:'monospace', fontSize:'0.9em'}}>{prod.sku || 'N/A'}</td>
                    <td>
                      <span onClick={() => {setSelectedProduct(prod); setShowProductDetails(true);}} style={{cursor:'pointer', textDecoration:'underline', color:'#3498db'}}>
                        {prod.name}
                      </span>
                      {prod.quantity === 0 && <span className="badge out-of-stock">Out of Stock</span>}
                      {prod.quantity > 0 && prod.quantity <= prod.minStock && <span className="badge low-stock">Low Stock</span>}
                    </td>
                    <td>
                      <span style={{
                        fontWeight: 'bold',
                        color: prod.quantity === 0 ? '#ef4444' : prod.quantity <= prod.minStock ? '#f59e0b' : '#10b981'
                      }}>
                        {prod.quantity}
                      </span>
                    </td>
                    <td>‚Çπ{prod.costPrice || 0}</td>
                    <td>‚Çπ{prod.price}</td>
                    <td style={{color: prod.profit > 0 ? 'green' : 'red', fontWeight: 'bold'}}>
                      ‚Çπ{prod.profit || 0} ({prod.profitPercent || 0}%)
                    </td>
                    <td>
                      <button onClick={() => {setSelectedProduct(prod); setShowProductDetails(true);}} className="btn-info" style={{padding:'5px 10px', marginRight:'5px'}}>View</button>
                      <button onClick={()=>requireAuth(()=>{
                        if(confirm(`Delete ${prod.name}?`)){
                          deleteProduct(prod.id);
                          addActivity('Product Deleted', prod.name);
                          showNotification(`${prod.name} deleted`, 'success');
                        }
                      })} className="btn-danger" style={{padding:'5px 10px'}}>Delete</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {tab==='inventory' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2>üì¶ Inventory Management</h2>
              <div style={{display:'flex',gap:'10px',alignItems:'center'}}>
                <input 
                  type="text" 
                  placeholder="üîç Search products..." 
                  value={searchQuery} 
                  onChange={e=>setSearchQuery(e.target.value)}
                  style={{padding:'8px 12px',borderRadius:'6px',border:'1px solid #ddd',minWidth:'250px'}}
                />
              </div>
            </div>

            {/* Stock Status Summary */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'15px',marginBottom:'25px'}}>
              <div style={{background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',padding:'20px',borderRadius:'10px',color:'white',boxShadow:'0 4px 6px rgba(0,0,0,0.1)'}}>
                <div style={{fontSize:'14px',opacity:'0.9'}}>‚úÖ In Stock</div>
                <div style={{fontSize:'32px',fontWeight:'bold',marginTop:'8px'}}>
                  {products.filter(p => p.quantity > p.minStock).length}
                </div>
              </div>
              <div style={{background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',padding:'20px',borderRadius:'10px',color:'white',boxShadow:'0 4px 6px rgba(0,0,0,0.1)'}}>
                <div style={{fontSize:'14px',opacity:'0.9'}}>‚ö†Ô∏è Low Stock</div>
                <div style={{fontSize:'32px',fontWeight:'bold',marginTop:'8px'}}>
                  {products.filter(p => p.quantity > 0 && p.quantity <= p.minStock).length}
                </div>
              </div>
              <div style={{background:'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',padding:'20px',borderRadius:'10px',color:'white',boxShadow:'0 4px 6px rgba(0,0,0,0.1)'}}>
                <div style={{fontSize:'14px',opacity:'0.9'}}>‚ùå Out of Stock</div>
                <div style={{fontSize:'32px',fontWeight:'bold',marginTop:'8px'}}>
                  {products.filter(p => p.quantity === 0).length}
                </div>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product Name</th>
                  <th>Current Stock</th>
                  <th>Min Stock</th>
                  <th>Status</th>
                  <th>Update Stock</th>
                </tr>
              </thead>
              <tbody>
                {getFilteredProducts().map(prod => (
                  <tr key={prod.id} className="fade-in table-row-hover">
                    <td style={{fontFamily:'monospace', fontSize:'0.9em'}}>{prod.sku || 'N/A'}</td>
                    <td>
                      <strong>{prod.name}</strong>
                      <div style={{fontSize:'0.85em',color:'#666'}}>{prod.category || 'Uncategorized'}</div>
                    </td>
                    <td>
                      <span style={{
                        fontSize: '18px',
                        fontWeight: 'bold',
                        color: prod.quantity === 0 ? '#ef4444' : prod.quantity <= prod.minStock ? '#f59e0b' : '#10b981'
                      }}>
                        {prod.quantity}
                      </span>
                    </td>
                    <td style={{color:'#666'}}>{prod.minStock || 5}</td>
                    <td>
                      {prod.quantity === 0 && <span className="badge out-of-stock">Out of Stock</span>}
                      {prod.quantity > 0 && prod.quantity <= prod.minStock && <span className="badge low-stock">Low Stock</span>}
                      {prod.quantity > prod.minStock && <span className="badge in-stock">In Stock</span>}
                    </td>
                    <td>
                      <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                        <input 
                          type="number" 
                          defaultValue={prod.quantity}
                          min="0"
                          style={{width:'80px',padding:'6px',borderRadius:'4px',border:'1px solid #ddd'}}
                          id={`qty-${prod.id}`}
                        />
                        <button 
                          onClick={()=>requireAuth(()=>{
                            const inputEl = document.getElementById(`qty-${prod.id}`);
                            const newQuantity = parseInt(inputEl.value) || 0;
                            if(newQuantity === prod.quantity) {
                              showNotification('No change in quantity', 'info');
                              return;
                            }
                            if(confirm(`Update stock for ${prod.name}?\n\nCurrent: ${prod.quantity}\nNew: ${newQuantity}`)){
                              updateStock(prod.id, newQuantity);
                              addActivity('Stock Updated', `${prod.name}: ${prod.quantity} ‚Üí ${newQuantity}`);
                              showNotification(`‚úÖ Stock updated: ${prod.name} now has ${newQuantity} units`, 'success');
                            }
                          })}
                          className="btn-primary" 
                          style={{padding:'6px 12px',whiteSpace:'nowrap'}}
                        >
                          üíæ Update
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {getFilteredProducts().length === 0 && (
                  <tr><td colSpan="6" style={{textAlign:'center',padding:'40px',color:'#999'}}>No products found</td></tr>
                )}
              </tbody>
            </table>
          </div>
        )}

        {tab==='customers' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2>Customers</h2>
              <button onClick={()=>requireAuth(()=>setShowAddCustomer(true))} className="btn-primary">+ Add Customer</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>GSTIN</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {customers.map(c=> (
                  <tr key={c.id}>
                    <td>{c.id}</td>
                    <td>{c.name}</td>
                    <td>{c.phone}</td>
                    <td style={{fontFamily:'monospace', fontSize:'0.9em'}}>{c.gstin || 'N/A'}</td>
                    <td style={{maxWidth:'200px', overflow:'hidden', textOverflow:'ellipsis'}}>{c.address}</td>
                    <td>
                      <button 
                        onClick={async () => {
                          setSelectedCustomerHistory(c);
                          const purchases = invoices.filter(inv => inv.customer_id === c.id);
                          setCustomerPurchases(purchases);
                          setShowCustomerHistory(true);
                        }}
                        style={{
                          padding: '6px 12px',
                          background: '#667eea',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '12px'
                        }}
                      >
                        üìä View History
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {tab==='invoices' && (
          <div>
            <h2>Invoice History</h2>
            <table>
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Customer</th>
                  <th>Subtotal</th>
                  <th>Discount</th>
                  <th>GST (18%)</th>
                  <th>Grand Total</th>
                  <th>Profit</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {invoices.map(inv => (
                  <tr key={inv.id}>
                    <td>#{inv.id}</td>
                    <td>{inv.customer_name || 'Walk-in'}</td>
                    <td>‚Çπ{inv.subtotal || 0}</td>
                    <td>{inv.discountPercent || 0}%</td>
                    <td>‚Çπ{inv.gstAmount || 0}</td>
                    <td style={{fontWeight: 'bold'}}>‚Çπ{inv.total}</td>
                    <td style={{color: 'green', fontWeight: 'bold'}}>‚Çπ{inv.totalProfit || 0}</td>
                    <td>{new Date(inv.created_at).toLocaleString()}</td>
                  </tr>
                ))}
                {invoices.length===0 && <tr><td colSpan="8">No invoices yet</td></tr>}
              </tbody>
            </table>
          </div>
        )}

        {tab==='reports' && (
          <div>
            <h2>Reports & Analytics</h2>
            
            {/* Download Reports Section */}
            <div className="download-reports-section">
              <h3>üì• Download Reports</h3>
              <p style={{color:'#666',marginBottom:'20px'}}>Export professional reports in CSV format for Excel, Google Sheets, or accounting software</p>
              <div className="download-buttons-grid">
                <button onClick={downloadSalesReport} className="download-btn sales">
                  <span className="btn-icon">üìä</span>
                  <div>
                    <strong>Sales Report</strong>
                    <small>All invoices with profit details</small>
                  </div>
                </button>
                <button onClick={downloadInventoryReport} className="download-btn inventory">
                  <span className="btn-icon">üì¶</span>
                  <div>
                    <strong>Inventory Report</strong>
                    <small>Stock levels, pricing & profit margins</small>
                  </div>
                </button>
                <button onClick={downloadCustomerReport} className="download-btn customers">
                  <span className="btn-icon">üë•</span>
                  <div>
                    <strong>Customer Report</strong>
                    <small>Customer database with GST details</small>
                  </div>
                </button>
                <button onClick={downloadProfitReport} className="download-btn profit">
                  <span className="btn-icon">üí∞</span>
                  <div>
                    <strong>Profit Analysis</strong>
                    <small>Complete financial overview</small>
                  </div>
                </button>
              </div>
            </div>

            {/* Summary Cards */}
            <div className="reports-grid" style={{marginTop:'30px'}}>
              <div className="report-card">
                <h3>üìä Sales Summary</h3>
                <p>Total Revenue: ‚Çπ{stats.totalRevenue || 0}</p>
                <p>Total Invoices: {stats.totalInvoices || 0}</p>
                <p>Average Sale: ‚Çπ{stats.totalInvoices > 0 ? Math.round(stats.totalRevenue / stats.totalInvoices) : 0}</p>
              </div>
              <div className="report-card">
                <h3>üì¶ Inventory Status</h3>
                <p>Total Products: {stats.totalProducts || 0}</p>
                <p>Low Stock Items: {stats.lowStockCount || 0}</p>
                <p>Well Stocked: {(stats.totalProducts || 0) - (stats.lowStockCount || 0)}</p>
              </div>
              <div className="report-card">
                <h3>üë• Customer Insights</h3>
                <p>Total Customers: {stats.totalCustomers || 0}</p>
                <p>Today's Sales: ‚Çπ{stats.todaySales || 0}</p>
              </div>
            </div>
          </div>
        )}

        {/* Users Management Tab (Admin Only) */}
        {tab==='users' && isAdmin && (
          <div className="users-management">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2>üë• User Management</h2>
              <div style={{display:'flex',gap:'10px',alignItems:'center'}}>
                <span style={{color:'#000',fontSize:'14px',fontWeight:'500'}}>
                  Total Users: {users.length} | Pending: {users.filter(u=>!u.approved).length}
                </span>
              </div>
            </div>
            
            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Registered</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {users.length === 0 ? (
                    <tr>
                      <td colSpan="6" style={{textAlign:'center',padding:'40px',color:'#999'}}>
                        No users registered yet
                      </td>
                    </tr>
                  ) : (
                    users.map(user => (
                      <tr key={user._id}>
                        <td>
                          <strong>{user.username}</strong>
                        </td>
                        <td>{user.email}</td>
                        <td>
                          <span className="badge" style={{
                            background: user.role === 'admin' ? '#667eea' : '#48bb78',
                            color: 'white',
                            padding: '4px 8px',
                            borderRadius: '4px',
                            fontSize: '12px'
                          }}>
                            {user.role}
                          </span>
                        </td>
                        <td>
                          {user.approved ? (
                            <span className="badge" style={{
                              background: '#48bb78',
                              color: 'white',
                              padding: '4px 8px',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }}>
                              ‚úì Approved
                            </span>
                          ) : (
                            <span className="badge" style={{
                              background: '#ed8936',
                              color: 'white',
                              padding: '4px 8px',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }}>
                              ‚è≥ Pending
                            </span>
                          )}
                        </td>
                        <td>
                          {new Date(user.createdAt).toLocaleDateString('en-IN', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                          })}
                        </td>
                        <td>
                          <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
                            {!user.approved ? (
                              <button 
                                onClick={() => approveUser(user._id)}
                                className="btn-success"
                                style={{
                                  padding: '6px 12px',
                                  fontSize: '12px',
                                  background: '#48bb78',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '4px',
                                  cursor: 'pointer'
                                }}
                              >
                                ‚úì Approve
                              </button>
                            ) : (
                              <button 
                                onClick={() => revokeUserAccess(user._id, user.username)}
                                style={{
                                  padding: '6px 12px',
                                  fontSize: '12px',
                                  background: '#ed8936',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '4px',
                                  cursor: 'pointer'
                                }}
                              >
                                ÔøΩ Revoke Access
                              </button>
                            )}
                            <button 
                              onClick={() => {
                                if(window.confirm(`Delete user "${user.username}"? They will be immediately logged out and removed permanently.`)) {
                                  deleteUser(user._id);
                                }
                              }}
                              className="btn-danger"
                              style={{
                                padding: '6px 12px',
                                fontSize: '12px',
                                background: '#f56565',
                                color: 'white',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: 'pointer'
                              }}
                            >
                              üóëÔ∏è Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Audit Logs Tab (Admin Only) */}
        {tab==='audit' && isAdmin && (
          <div className="audit-logs">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2>üìã Audit Trail Logs</h2>
              <button onClick={fetchAuditLogs} className="btn-primary" style={{padding:'8px 16px'}}>
                üîÑ Refresh
              </button>
            </div>
            
            <div style={{background:'white',borderRadius:'15px',padding:'20px',boxShadow:'0 4px 15px rgba(0,0,0,0.1)'}}>
              <p style={{color:'#666',marginBottom:'20px',fontSize:'14px'}}>
                Complete audit trail of all system changes. Track who made what changes and when.
              </p>
              
              <div className="table-container" style={{maxHeight:'70vh',overflowY:'auto'}}>
                <table>
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>User</th>
                      <th>Action</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    {auditLogs.length === 0 ? (
                      <tr>
                        <td colSpan="4" style={{textAlign:'center',padding:'40px',color:'#999'}}>
                          No audit logs yet
                        </td>
                      </tr>
                    ) : (
                      auditLogs.map(log => (
                        <tr key={log.id}>
                          <td style={{fontSize:'13px',color:'#666',whiteSpace:'nowrap'}}>
                            {new Date(log.timestamp).toLocaleString('en-IN', {
                              year: 'numeric',
                              month: 'short',
                              day: 'numeric',
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit'
                            })}
                          </td>
                          <td>
                            <span style={{
                              background: log.username === 'admin' ? '#667eea' : '#48bb78',
                              color: 'white',
                              padding: '4px 10px',
                              borderRadius: '12px',
                              fontSize: '12px',
                              fontWeight: '600'
                            }}>
                              {log.username}
                            </span>
                          </td>
                          <td>
                            <span style={{
                              background: 
                                log.action.includes('DELETE') ? '#f56565' :
                                log.action.includes('ADD') || log.action.includes('COMPLETE') ? '#48bb78' :
                                log.action.includes('UPDATE') ? '#ed8936' : '#667eea',
                              color: 'white',
                              padding: '4px 8px',
                              borderRadius: '4px',
                              fontSize: '11px',
                              fontWeight: '600',
                              textTransform: 'uppercase',
                              letterSpacing: '0.5px'
                            }}>
                              {log.action.replace(/_/g, ' ')}
                            </span>
                          </td>
                          <td style={{fontSize:'13px'}}>
                            {log.details && (
                              <div style={{maxWidth:'400px'}}>
                                {log.details.productName && <span>Product: <strong>{log.details.productName}</strong></span>}
                                {log.details.customerName && <span>Customer: <strong>{log.details.customerName}</strong></span>}
                                {log.details.billNumber && <span>Bill: <strong>{log.details.billNumber}</strong></span>}
                                {log.details.oldQuantity !== undefined && (
                                  <span> | Stock: {log.details.oldQuantity} ‚Üí {log.details.newQuantity} 
                                    <span style={{
                                      color: log.details.change > 0 ? '#48bb78' : '#f56565',
                                      fontWeight: 'bold'
                                    }}>
                                      ({log.details.change > 0 ? '+' : ''}{log.details.change})
                                    </span>
                                  </span>
                                )}
                                {log.details.grandTotal && <span> | Total: ‚Çπ{log.details.grandTotal}</span>}
                                {log.details.profit !== undefined && (
                                  <span style={{color:'#48bb78',fontWeight:'bold'}}> | Profit: ‚Çπ{log.details.profit}</span>
                                )}
                              </div>
                            )}
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
              
              {auditLogs.length > 0 && (
                <div style={{marginTop:'20px',textAlign:'center',color:'#999',fontSize:'13px'}}>
                  Showing last {auditLogs.length} activities
                </div>
              )}
            </div>
          </div>
        )}
      </main>

      {/* Add Product Modal */}
      {showAddProduct && (
        <div className="modal-overlay" onClick={()=>setShowAddProduct(false)}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <h2>Add New Product</h2>
            <form onSubmit={(e)=>{e.preventDefault(); addProduct();}}>
              <div className="form-group">
                <label>Product Name</label>
                <input 
                  type="text" 
                  value={newProduct.name} 
                  onChange={(e)=>setNewProduct({...newProduct, name:e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label>SKU/Barcode (Optional)</label>
                <input 
                  type="text" 
                  value={newProduct.sku} 
                  onChange={(e)=>setNewProduct({...newProduct, sku:e.target.value})}
                  placeholder="e.g., PRD-001, 1234567890123"
                />
              </div>
              <div className="form-group">
                <label>Quantity</label>
                <input 
                  type="number" 
                  value={newProduct.quantity} 
                  onChange={(e)=>setNewProduct({...newProduct, quantity:e.target.value})}
                  required
                  min="0"
                />
              </div>
              <div className="form-group">
                <label>Minimum Stock Level</label>
                <input 
                  type="number" 
                  value={newProduct.minStock} 
                  onChange={(e)=>setNewProduct({...newProduct, minStock:e.target.value})}
                  required
                  min="0"
                  placeholder="Alert when stock falls below this"
                />
              </div>
              <div className="form-group">
                <label>Cost Price (‚Çπ)</label>
                <input 
                  type="number" 
                  value={newProduct.costPrice} 
                  onChange={(e)=>setNewProduct({...newProduct, costPrice:e.target.value})}
                  required
                  min="0"
                  step="0.01"
                  placeholder="Purchase/Cost price"
                />
              </div>
              <div className="form-group">
                <label>Selling Price (‚Çπ)</label>
                <input 
                  type="number" 
                  value={newProduct.price} 
                  onChange={(e)=>setNewProduct({...newProduct, price:e.target.value})}
                  required
                  min="0"
                  step="0.01"
                  placeholder="Selling price to customers"
                />
              </div>
              <div className="form-group">
                <label>HSN Code</label>
                <input 
                  type="text" 
                  value={newProduct.hsnCode} 
                  onChange={(e)=>setNewProduct({...newProduct, hsnCode:e.target.value})}
                  placeholder="HSN/SAC code for GST"
                />
              </div>
              <div className="modal-actions">
                <button type="submit" className="btn-primary">Add Product</button>
                <button type="button" onClick={()=>setShowAddProduct(false)} className="btn-secondary">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Customer Modal */}
      {showAddCustomer && (
        <div className="modal-overlay" onClick={()=>setShowAddCustomer(false)}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <h2>Add New Customer</h2>
            <form onSubmit={(e)=>{e.preventDefault(); addCustomer();}}>
              <div className="form-group">
                <label>Customer Name</label>
                <input 
                  type="text" 
                  value={newCustomer.name} 
                  onChange={(e)=>setNewCustomer({...newCustomer, name:e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label>Phone</label>
                <input 
                  type="tel" 
                  value={newCustomer.phone} 
                  onChange={(e)=>setNewCustomer({...newCustomer, phone:e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label>Address</label>
                <input 
                  type="text" 
                  value={newCustomer.address} 
                  onChange={(e)=>setNewCustomer({...newCustomer, address:e.target.value})}
                />
              </div>
              <div className="form-group">
                <label>GSTIN (Optional)</label>
                <input 
                  type="text" 
                  value={newCustomer.gstin} 
                  onChange={(e)=>setNewCustomer({...newCustomer, gstin:e.target.value.toUpperCase()})}
                  placeholder="e.g., 29AABCT1234L1Z5"
                  pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}"
                  title="Valid GSTIN format: 29AABCT1234L1Z5"
                  maxLength="15"
                />
              </div>
              <div className="modal-actions">
                <button type="submit" className="btn-primary">Add Customer</button>
                <button type="button" onClick={()=>setShowAddCustomer(false)} className="btn-secondary">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      )}



      {/* Customer Purchase History Modal */}
      {showCustomerHistory && selectedCustomerHistory && (
        <div className="modal-overlay" onClick={()=>setShowCustomerHistory(false)}>
          <div className="modal-content" style={{maxWidth: '900px'}} onClick={(e)=>e.stopPropagation()}>
            <h2>üìä Purchase History - {selectedCustomerHistory.name}</h2>
            <div style={{marginBottom: '20px', padding: '15px', background: '#f7fafc', borderRadius: '8px'}}>
              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                <p><strong>Phone:</strong> {selectedCustomerHistory.phone}</p>
                <p><strong>GSTIN:</strong> {selectedCustomerHistory.gstin || 'N/A'}</p>
                <p style={{gridColumn: '1 / -1'}}><strong>Address:</strong> {selectedCustomerHistory.address}</p>
              </div>
              <div style={{marginTop: '15px', display: 'flex', gap: '20px', justifyContent: 'center'}}>
                <div style={{textAlign: 'center', padding: '10px', background: 'white', borderRadius: '8px', flex: 1}}>
                  <div style={{fontSize: '24px', fontWeight: 'bold', color: '#667eea'}}>
                    {customerPurchases.length}
                  </div>
                  <div style={{fontSize: '12px', color: '#666'}}>Total Purchases</div>
                </div>
                <div style={{textAlign: 'center', padding: '10px', background: 'white', borderRadius: '8px', flex: 1}}>
                  <div style={{fontSize: '24px', fontWeight: 'bold', color: '#48bb78'}}>
                    ‚Çπ{customerPurchases.reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0).toFixed(2)}
                  </div>
                  <div style={{fontSize: '12px', color: '#666'}}>Total Spent</div>
                </div>
                <div style={{textAlign: 'center', padding: '10px', background: 'white', borderRadius: '8px', flex: 1}}>
                  <div style={{fontSize: '24px', fontWeight: 'bold', color: '#f6ad55'}}>
                    ‚Çπ{customerPurchases.length > 0 ? (customerPurchases.reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0) / customerPurchases.length).toFixed(2) : '0.00'}
                  </div>
                  <div style={{fontSize: '12px', color: '#666'}}>Avg Purchase</div>
                </div>
              </div>
            </div>
            
            {customerPurchases.length > 0 ? (
              <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                <table>
                  <thead>
                    <tr>
                      <th>Invoice #</th>
                      <th>Date</th>
                      <th>Items</th>
                      <th>Discount</th>
                      <th>Total Amount</th>
                      <th>Payment Mode</th>
                    </tr>
                  </thead>
                  <tbody>
                    {customerPurchases.map(inv => (
                      <tr key={inv.id}>
                        <td>#{inv.id}</td>
                        <td>{new Date(inv.created_at).toLocaleDateString('en-IN')}</td>
                        <td>{inv.items?.length || 0} items</td>
                        <td>{inv.discountPercent || 0}%</td>
                        <td style={{fontWeight: 'bold', color: '#667eea'}}>‚Çπ{inv.total}</td>
                        <td>{inv.paymentMode || 'Cash'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div style={{textAlign: 'center', padding: '40px', color: '#999'}}>
                <div style={{fontSize: '48px', marginBottom: '10px'}}>üõçÔ∏è</div>
                <p>No purchase history found for this customer</p>
              </div>
            )}
            
            <div className="modal-actions" style={{marginTop: '20px'}}>
              <button onClick={()=>setShowCustomerHistory(false)} className="btn-secondary">Close</button>
            </div>
          </div>
        </div>
      )}

      {/* Transaction Bill Modal */}
      {showBill && lastBill && (
        <div className="modal-overlay" onClick={()=>setShowBill(false)}>
          <div className="modal-content bill-modal" onClick={(e)=>e.stopPropagation()}>
            <div id="bill-print-content">
              <div className="bill-header">
                <h2>‚ö° 26:07 ELECTRONICS</h2>
                <h3>Premium Electronics & Smart Solutions</h3>
                <p>Tax Invoice</p>
              </div>
              
              <div className="bill-info">
                <p><strong>Bill No:</strong> {lastBill.billNumber}</p>
                <p><strong>Date:</strong> {new Date().toLocaleString()}</p>
                <p><strong>Customer:</strong> {lastBill.customerName}</p>
                {lastBill.customerPhone && <p><strong>Phone:</strong> {lastBill.customerPhone}</p>}
                <p><strong>Payment Mode:</strong> {lastBill.paymentMode}</p>
              </div>

              <table>
                <thead>
                  <tr>
                    <th style={{textAlign:'left'}}>Item</th>
                    <th style={{textAlign:'center'}}>Qty</th>
                    <th style={{textAlign:'right'}}>Price</th>
                    <th style={{textAlign:'right'}}>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {lastBill.items && lastBill.items.map((item, idx) => (
                    <tr key={idx}>
                      <td>{item.productName}</td>
                      <td style={{textAlign:'center'}}>{item.quantity}</td>
                      <td style={{textAlign:'right'}}>‚Çπ{item.unitPrice}</td>
                      <td style={{textAlign:'right'}}>‚Çπ{item.lineSubtotal.toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>

              <div className="bill-summary">
                <div><span>Subtotal:</span><span>‚Çπ{lastBill.subtotal.toFixed(2)}</span></div>
                {lastBill.discountAmount > 0 && (
                  <div><span>Discount ({lastBill.discountPercent}%):</span><span>-‚Çπ{lastBill.discountAmount.toFixed(2)}</span></div>
                )}
                <div><span>Taxable Amount:</span><span>‚Çπ{lastBill.afterDiscount.toFixed(2)}</span></div>
                <div><span>GST (18%):</span><span>‚Çπ{lastBill.gstAmount.toFixed(2)}</span></div>
                <div className="grand-total">
                  <span><strong>Grand Total:</strong></span>
                  <span><strong>‚Çπ{lastBill.grandTotal.toFixed(2)}</strong></span>
                </div>
              </div>

              <div className="bill-footer">
                <p><strong>Thank you for your business!</strong></p>
                <p>¬© {new Date().getFullYear()} Shahinsha</p>
              </div>
            </div>

            <div className="modal-actions" style={{marginTop:'20px'}}>
              <button onClick={printBill} className="btn-primary">üñ®Ô∏è Print Bill</button>
              <button onClick={()=>setShowBill(false)} className="btn-secondary">Close</button>
            </div>
          </div>
        </div>
      )}

      {/* Copyright Footer */}
      <footer className="copyright-footer">
        <div className="footer-content">
          <p>¬© {new Date().getFullYear()} Shahinsha</p>
        </div>
      </footer>
    </div>
  )
}
